# Document Creation System - 画面仕様書

## 概要

各画面の構成要素、データフロー、ユーザーインタラクションを定義する。

---

## 1. 認証画面

### 1.1 ログイン画面 (`/login`)

**目的**: Keycloakへのリダイレクト

**要素**:
- 「ログイン」ボタン

**処理フロー**:
1. ボタンクリック
2. Keycloak認証画面にリダイレクト
3. 認証後、`/auth/callback`にリダイレクト

---

### 1.2 招待受諾画面 (`/invite/{token}`)

**目的**: 招待リンクからの病院参加

**要素**:
- 招待情報表示（病院名、付与されるロール）
- 「参加する」ボタン

**処理フロー**:
1. トークン検証
2. 有効な招待であれば情報表示
3. ボタンクリックでKeycloak認証
4. 認証後、自動的にメンバーシップ作成
5. 病院ダッシュボードにリダイレクト

**エラーケース**:
- 無効なトークン → エラーメッセージ表示
- 期限切れ → エラーメッセージ表示
- 既に受諾済み → 病院ダッシュボードにリダイレクト

---

### 1.3 病院未所属画面 (`/no-hospital`)

**目的**: 病院に所属していないユーザーへの案内

**要素**:
- 説明メッセージ
- ログアウトボタン

---

## 2. サービス管理者画面

### 2.1 管理者ダッシュボード (`/admin`)

**目的**: 全病院の概要確認

**要素**:
- 統計サマリー
  - 病院数
  - ユーザー数
  - 本日の計画書数
- 病院一覧（最新5件）
- クイックリンク

**レイアウト**:
```
┌─────────────────────────────────────────────┐
│ [サイドナビ] │ [メインコンテンツ]            │
│              │                              │
│ ダッシュボード │ 統計サマリー                  │
│ 病院管理      │ ┌───┐ ┌───┐ ┌───┐           │
│ APIクライアント│ │ N │ │ N │ │ N │           │
│ 監査ログ      │ └───┘ └───┘ └───┘           │
│              │                              │
│ [ログアウト]  │ 病院一覧                     │
│              │ ├─ 病院A                     │
│              │ ├─ 病院B                     │
│              │ └─ ...                       │
└─────────────────────────────────────────────┘
```

---

### 2.2 病院一覧 (`/admin/hospitals`)

**目的**: 全病院の管理

**要素**:
- 「新規作成」ボタン
- 病院テーブル
  - 病院名
  - スラッグ
  - メンバー数
  - 作成日
  - アクション（詳細リンク）

---

### 2.3 病院作成 (`/admin/hospitals/new`)

**目的**: 新規病院の作成

**フォーム要素**:
| フィールド | 種類 | 必須 | バリデーション |
|-----------|------|------|---------------|
| 病院名 | text | ○ | 1-255文字 |
| スラッグ | text | ○ | 英数字・ハイフンのみ、2-100文字、一意 |

**処理フロー**:
1. フォーム入力
2. サブミット
3. バリデーション
4. 病院作成
5. 病院詳細にリダイレクト

---

### 2.4 病院詳細 (`/admin/hospitals/{id}`)

**目的**: 病院情報の確認・編集・管理者招待

**要素**:
- 病院情報表示/編集フォーム
- 管理者招待フォーム
  - メールアドレス入力
  - 「招待」ボタン
- メンバー一覧
- 削除ボタン（確認ダイアログ付き）

---

### 2.5 APIクライアント一覧 (`/admin/api-clients`)

**目的**: 全APIクライアントの管理

**要素**:
- 「新規作成」ボタン
- クライアントテーブル
  - 名前
  - Client ID
  - スコープ（システム全体/病院名）
  - ステータス（有効/無効）
  - 作成日
  - アクション

---

### 2.6 APIクライアント作成 (`/admin/api-clients/new`)

**目的**: 新規APIクライアントの作成

**フォーム要素**:
| フィールド | 種類 | 必須 | 説明 |
|-----------|------|------|------|
| クライアント名 | text | ○ | 表示名 |
| 説明 | textarea | - | 用途説明 |
| スコープ | radio | ○ | システム全体 / 病院選択 |
| 病院 | select | △ | 病院スコープ時のみ |

**作成成功時の表示**:
```
┌─────────────────────────────────────────────┐
│ APIクライアントが作成されました              │
│                                             │
│ Client ID: dc-client-xxxxxxxx               │
│ [コピー]                                    │
│                                             │
│ Client Secret: xxxxxxxxxxxxxxxxxxxxxxxx     │
│ [コピー]                                    │
│                                             │
│ ⚠️ Client Secretは今後表示されません        │
│   安全な場所に保存してください              │
│                                             │
│ [一覧に戻る]                                │
└─────────────────────────────────────────────┘
```

---

### 2.7 監査ログ (`/admin/audit-logs`)

**目的**: システム全体の操作履歴確認

**要素**:
- フィルターセクション
  - 病院選択
  - ユーザー選択
  - 操作種別
  - 対象種別
  - 期間（開始〜終了）
  - 検索ボタン、クリアボタン
- 件数表示
- ログテーブル
  - 日時
  - 操作種別
  - 対象
  - ユーザー
  - 病院
  - 結果（成功/失敗）
  - 詳細ボタン
- ページネーション

**詳細モーダル/ダイアログ**:
- メタデータ（JSON形式）
- 変更内容（before/after）
- エラーメッセージ（失敗時）
- IPアドレス
- User-Agent

---

## 3. 病院ユーザー画面

### 3.1 病院ダッシュボード (`/{slug}`)

**目的**: 病院の概要確認

**要素**:
- 統計サマリー
  - 患者数
  - 本月の計画書数
  - 本日の予定
- 最近の計画書一覧
- クイックリンク

---

### 3.2 患者一覧 (`/{slug}/patients`)

**目的**: 患者の検索・管理

**要素**:
- 検索ボックス（患者番号、氏名で検索）
- 「新規登録」ボタン
- 患者テーブル
  - 患者番号
  - 氏名
  - 生年月日
  - 性別
  - 最終計画書日
  - アクション（詳細リンク）
- ページネーション

**新規登録モーダル**:
| フィールド | 種類 | 必須 | バリデーション |
|-----------|------|------|---------------|
| 患者番号 | text | ○ | 病院内一意 |
| 氏名 | text | ○ | 1-100文字 |
| 氏名カナ | text | - | カタカナのみ |
| 生年月日 | date | ○ | 過去日 |
| 性別 | select | ○ | 男性/女性 |

---

### 3.3 患者詳細 (`/{slug}/patients/{patientId}`)

**目的**: 患者情報と計画書履歴の確認

**要素**:
- 患者情報カード
  - 患者番号
  - 氏名
  - 生年月日・年齢
  - 性別
- 「新規計画書作成」ボタン
- 計画書履歴テーブル
  - 回数
  - 種別
  - 診療日
  - ステータス
  - アクション（詳細、PDF）

---

### 3.4 計画書作成 (`/{slug}/patients/{patientId}/care-plans/new`)

**目的**: 療養計画書の新規作成

**レイアウト**:
```
┌─────────────────────────────────────────────┐
│ 療養計画書作成                              │
│ 患者: 山田太郎 (12345)                      │
├─────────────────────────────────────────────┤
│ ▼ 基本情報                                  │
│   計画書種別: ○初回 ○継続                  │
│   回数: [___]                               │
│   記入日: [日付選択]                        │
│   診療日: [日付選択]                        │
├─────────────────────────────────────────────┤
│ ▼ 主病                                      │
│   □糖尿病 □高血圧症 □高脂血症              │
├─────────────────────────────────────────────┤
│ ▼ 検査項目                                  │
│   身長: [___] cm                            │
│   体重: 現在[___] 目標[___] kg              │
│   BMI: [自動計算]                           │
│   ...                                       │
├─────────────────────────────────────────────┤
│ ▼ 血液検査                                  │
│   採血日: [日付選択]                        │
│   血糖: [___] mg/dl (○空腹時 ○随時 ○食後) │
│   ...                                       │
├─────────────────────────────────────────────┤
│ ▼ 問診                                      │
│   食事の状況: [テキストエリア]              │
│   ...                                       │
├─────────────────────────────────────────────┤
│ ▼ 目標                                      │
│   達成目標: [テキストエリア]                │
│   行動目標: [テキストエリア]                │
│   （継続用のみ）                            │
│   目標達成状況: [テキストエリア]            │
│   次の目標: [テキストエリア]                │
├─────────────────────────────────────────────┤
│ ▼ 重点指導項目                              │
│   [食事] [運動] [たばこ] [その他] タブ切替  │
│   ...                                       │
├─────────────────────────────────────────────┤
│ ▼ 署名・担当者                              │
│   患者署名: [___]                           │
│   主治医: [選択]                            │
│   担当者: 食事[選択] 運動[選択] ...         │
├─────────────────────────────────────────────┤
│ [下書き保存] [作成完了]                     │
└─────────────────────────────────────────────┘
```

**フォームセクション**:

1. **基本情報**
   - 計画書種別（ラジオ）
   - 回数（数値、継続時のみ編集可）
   - 記入日（日付）
   - 診療日（日付）

2. **主病**
   - 糖尿病（チェックボックス）
   - 高血圧症（チェックボックス）
   - 高脂血症（チェックボックス）
   - ※1つ以上必須

3. **検査項目**
   - 身長 cm
   - 体重 現在/目標 kg
   - BMI（自動計算）
   - 腹囲 現在/目標 cm
   - 栄養状態（選択）
   - 血圧 収縮期/拡張期 mmHg
   - 運動負荷心電図（チェック）

4. **血液検査**
   - 採血日
   - 血糖測定条件（ラジオ）
   - 食後時間（条件が食後の場合）
   - 血糖 mg/dl
   - HbA1c 現在/目標 %
   - 総コレステロール mg/dl
   - 中性脂肪 mg/dl
   - HDL/LDLコレステロール mg/dl

5. **問診**
   - 食事の状況（テキストエリア）
   - 運動の状況（テキストエリア）
   - たばこ（テキストエリア）
   - その他の生活（テキストエリア）

6. **目標**
   - 達成目標（テキストエリア）
   - 行動目標（テキストエリア）
   - 目標達成状況（継続のみ）
   - 次の目標（継続のみ）

7. **重点指導項目（タブ切替）**
   - 食事指導タブ
   - 運動指導タブ
   - たばこ指導タブ
   - その他タブ

8. **服薬指導**
   - 処方なし（チェック）
   - 服薬説明（チェック）

9. **問題点**
   - 療養上の問題点（テキストエリア）
   - 他施設利用状況（テキストエリア）

10. **署名・担当者**
    - 患者署名
    - 主治医（選択）
    - 担当医（選択）
    - 各領域担当者（選択）

---

### 3.5 計画書詳細 (`/{slug}/patients/{patientId}/care-plans/{planId}`)

**目的**: 計画書内容の確認

**要素**:
- 患者情報
- 計画書全項目の読み取り専用表示
- 「PDF出力」ボタン
- 「編集」ボタン（ステータスがdraftの場合）

---

### 3.6 診療日別一覧 (`/{slug}/care-plans`)

**目的**: 診療日ごとの計画書確認

**要素**:
- 月ナビゲーション（前月/次月）
- カレンダービューまたは日付グループ表示
- 各日付の計画書リスト
  - 患者名
  - 種別
  - ステータス
  - リンク

---

### 3.7 メンバー一覧 (`/{slug}/members`)

**目的**: 病院メンバーの管理

**要素**:
- 「招待」ボタン（管理者のみ）
- メンバーテーブル
  - 名前
  - メール
  - ロール
  - 参加日

**招待モーダル**:
| フィールド | 種類 | 必須 |
|-----------|------|------|
| メールアドレス | email | ○ |
| ロール | select | ○ |

---

## 4. 共通コンポーネント

### 4.1 ヘッダー

**要素**:
- アプリ名/ロゴ
- ユーザー名
- ログアウトリンク

### 4.2 サイドナビゲーション

**管理者用**:
- ダッシュボード
- 病院管理
- APIクライアント
- 監査ログ
- ログアウト

**病院ユーザー用**:
- ダッシュボード
- 患者一覧
- 診療日別一覧
- メンバー
- 設定（管理者のみ）
- ログアウト

### 4.3 モーダル

**共通スタイル**:
- オーバーレイ背景
- 中央配置
- 閉じるボタン
- ESCキーで閉じる

### 4.4 テーブル

**共通機能**:
- ソート
- ページネーション
- 空状態メッセージ

### 4.5 フォーム

**共通機能**:
- バリデーションエラー表示
- 必須マーク
- ローディング状態
- 成功/エラーメッセージ

---

## 5. レスポンシブ対応

### ブレークポイント

| 名前 | 幅 | 対応 |
|------|-----|------|
| mobile | < 768px | 縦積みレイアウト |
| tablet | 768px - 1024px | 調整レイアウト |
| desktop | > 1024px | フルレイアウト |

### モバイル対応

- サイドナビ → ハンバーガーメニュー
- テーブル → カード表示
- フォーム → 縦積み
